# 概念

数据竞争(data race)

# 引子

某个工作日，开发团队上午在会议室开会，在白板上画架构图，画到一半，到饭点了，大家说先吃饭，等下午接着讨论，于是都去吃饭了。过了一会，产品团队突然有一个紧急问题要开会，去了同一个会议室，把白板擦干净，然后画上了产品用户故事地图。等开发团队吃完饭回来一看，会议室白板上画到一半的架构图已经变成产品用户故事地图了。

# 解释

数据竞争是指两个线程在线程不安全的情况下，对同一个地址进行写操作。

## 两个线程

开发团队和产品团队可以看作两个线程

## 写入同一个地址

两个团队都使用了同一个会议室的白板

## 如何避免？

### 操作原子化

每场会议都变成原子操作，要么不开始，要么一开始就不能中断，一直执行到结束。

### 加锁

开发团队使用的会议室，没用完之前就把门锁上，就算中途去吃饭了，也锁上门，其他部门就不会动到开发团队的白板了。

### 使用协程加通道

假设白板是可以复制的。
开发团队去吃饭前，复制一个画着一半架构图的白板，放到桌子上，并把白板擦干净，然后去吃饭。
产品团队开紧急会议时，使用白板，使用完后，把白板擦干净。
当开发团队吃饭回来时，把桌上的复制白板再恢复到墙上白板，继续画架构图。
白板从墙上到桌上，再从桌上到墙上，这两个动作通过通道来处理，这是Golang语言里常见的一种用法。

# 实例

- 多线程程序中，忘记加锁就可能导致数据竞争
- 在线合作编辑软件，比如在线Excel表格，多人同时编辑，有可能你写的内容会被别人修改

# 思考题

生活中你见过数据竞争的例子吗？

## 扩展：伯恩斯坦条件

满足伯恩斯坦条件的两个过程，可以并行执行。
感兴趣可以自行搜索资料查看。
